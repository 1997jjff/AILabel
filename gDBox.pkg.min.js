(function(global) {
    (function(){var initializing=false;gClass=function(){};gClass.extend=function(prop){var baseClass=null;if(this!==gClass){baseClass=this}function F(){if(!initializing){if(baseClass){this._superprototype=baseClass.prototype}this.init.apply(this,arguments)}}if(baseClass){initializing=true;F.prototype=new baseClass();F.prototype.constructor=F;initializing=false}F.extend=arguments.callee;for(var name in prop){if(prop.hasOwnProperty(name)){if(baseClass&&typeof(prop[name])==="function"&&typeof(F.prototype[name])==="function"&&/\b_super\b/.test(prop[name])){F.prototype[name]=(function(name,fn){return function(){this._super=baseClass.prototype[name];return fn.apply(this,arguments)}})(name,prop[name])}else{F.prototype[name]=prop[name]}}}return F}})();var gDBox={};gDBox.config={"version":"1.1.0"};gDBox.Util={};gDBox.Util.createDiv=function(id,w,h,pos){var div=document.createElement("div");div.id=id;div.style.width=w+"px";div.style.height=h+"px";if(pos){div.style.position="absolute"}div.style.zIndex=1;return div};gDBox.Util.createCanvas=function(id,w,h,pos){var canvas=document.createElement("canvas");canvas.id=id;canvas.width=w;canvas.height=h;canvas.style.width=w+"px";canvas.style.height=h+"px";if(pos){canvas.style.position="absolute"}return canvas};gDBox.Util.isInArray=function(arr,val){for(var i in arr){if(arr[i]==val){return true}}return false};gDBox.Util.isObjInArray=function(arr,obj){for(var i in arr){if(arr[i].id==obj.id){alert("已被添加，请更换图层id"+obj.id);return true}}return false};gDBox.Util.setStyle=function(ctx,style){ctx.fillStyle=style.fillColor;ctx.strokeStyle=style.strokeColor;ctx.lineWidth=style.lineWeight;ctx.globalAlpha=style.opacity;return true};gDBox.Util.worldToScreen=function(gMap,wx,wy){var cxy=gMap.getCenter();var wcx=cxy.x;var wcy=cxy.y;var scx=parseInt(gMap.w)/2;var scy=parseInt(gMap.h)/2;var scale=gMap.zoom/parseInt(gMap.w);var sx=parseFloat(scx)+parseFloat((wx-wcx)/scale)+0;var sy=parseFloat(scy)-parseFloat((wy-wcy)/scale)+0;return{x:sx,y:sy}};gDBox.Util.screenToWorld=function(gMap,sx,sy){var cxy=gMap.getCenter();var wcx=cxy.x;var wcy=cxy.y;var scx=parseInt(gMap.w)/2;var scy=parseInt(gMap.h)/2;var scale=gMap.zoom/parseInt(gMap.w);var wx=parseFloat(wcx)+parseFloat((sx-scx)*scale);var wy=parseFloat(wcy)-parseFloat((sy-scy)*scale);return{x:wx,y:wy}};gDBox.Util.addEvtHandler=function(element,evt,func){element["on"+evt]=func;if(evt=="mousewheel"&&gDBox.Util.getIEVersion()==0){element.addEventListener("DOMMouseScroll",func,false)}};gDBox.Util.removeEvtHandler=function(element,evt){element["on"+evt]=null};gDBox.Util.getMouseXY=function(ele,e){var x=0,y=0;var obj=e.srcElement?e.srcElement:e.target;if(obj.nodeType!=1){return{x:x,y:y}}if(!document.attachEvent){while(obj&&obj!=ele){var btw=gDBox.Util.getEleStyle(obj,"border-top-width")=="medium"?0:gDBox.Util.delpx(gDBox.Util.getEleStyle(obj,"border-top-width"));var blw=gDBox.Util.getEleStyle(obj,"border-left-width")=="medium"?0:gDBox.Util.delpx(gDBox.Util.getEleStyle(obj,"border-left-width"));x+=obj.offsetLeft+blw;y+=obj.offsetTop+btw;obj=obj.offsetParent}x=e.offsetX+x+document.body.scrollLeft;y=e.offsetY+y+document.body.scrollTop}else{var btw=gDBox.Util.getEleStyle(obj,"border-top-width")=="medium"?0:gDBox.Util.delpx(gDBox.Util.getEleStyle(obj,"border-top-width"));var blw=gDBox.Util.getEleStyle(obj,"border-left-width")=="medium"?0:gDBox.Util.delpx(gDBox.Util.getEleStyle(obj,"border-left-width"));x=e.layerX-blw;y=e.layerY-btw}return{x:x,y:y}};gDBox.Util.getMousePos=function(event){var e=event||window.event;return{"x":e.screenX,"y":e.screenY}};gDBox.Util.getEleStyle=function(obj,attribute){var arr=attribute.split("-");var attr=arr[0];if(attr.length>1){for(var i=1;i<arr.length;i++){attr+=arr[i].substring(0,1).toUpperCase()+arr[i].substring(1)}}else{attr=attribute}return obj.currentStyle?obj.currentStyle[attr]:document.defaultView.getComputedStyle(obj,false)[attr]};gDBox.Util.delpx=function(value){if(value==""){return 0}return parseInt(value.substring(0,value.length-2))};gDBox.Util.getRectPointsWithSAndE=function(startPoint,endPoint){var pt1x=endPoint.x;var pt1y=startPoint.y;var pt3x=startPoint.x;var pt3y=endPoint.y;return[{x:startPoint.x,y:startPoint.y},{x:pt1x,y:pt1y},{x:endPoint.x,y:endPoint.y},{x:pt3x,y:pt3y}]};gDBox.Util.pointInPoly=function(pt,poly){for(var c=false,i=-1,l=poly.length,j=l-1;++i<l;j=i){((poly[i].y<=pt.y&&pt.y<poly[j].y)||(poly[j].y<=pt.y&&pt.y<poly[i].y))&&(pt.x<(poly[j].x-poly[i].x)*(pt.y-poly[i].y)/(poly[j].y-poly[i].y)+poly[i].x)&&(c=!c)}return c};gDBox.Util.preventDefault=function(event){if(event.preventDefault){event.preventDefault()}else{window.event.returnValue=false}};gDBox.Util.stopPropagation=function(event){if(event.stopPropagation){event.stopPropagation()}else{window.event.cancelBubble=true}};gDBox.Util.getButton=function(event){event=event||window.event;if(!+[1,]){switch(event.button){case 0:case 1:case 3:case 5:case 7:return 0;case 2:case 6:return 2;case 4:return 1}}else{return event.button}};gDBox.Util.createTextArea=function(id,w,h,pos){var div=document.createElement("textarea");
    div.id=id;div.style.width=w+"px";div.style.height=h+"px";div.style.resize="none";if(pos){div.style.position="absolute"}div.style.zIndex=1;return div};gDBox.Util.colorRgb=function(strColor,opacity){var gcolor_reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;var sColor=strColor.toLowerCase();if(sColor&&gcolor_reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1))}sColor=sColorNew}var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)))}return"RGBA("+sColorChange.join(",")+","+opacity+")"}else{return sColor}};gDBox.Util.getIEVersion=function(){var userAgent=window.navigator.userAgent.toLowerCase();if(/msie 8\.0/i.test(userAgent)){return 8}if(/msie 7\.0/i.test(userAgent)){return 7}if(/msie 6\.0/i.test(userAgent)){return 6}return 0};gDBox.Graph={};gDBox.Graph.drawPoint=function(ctx,pt){ctx.beginPath();ctx.arc(pt.x,pt.y,2,0,Math.PI*2,true);ctx.closePath();ctx.fill()};gDBox.Graph.drawPoint_geo=function(gMap,ctx,pt){var sxy=gDBox.Util.worldToScreen(gMap,pt.x,pt.y);ctx.beginPath();ctx.arc(sxy.x,sxy.y,3,0,Math.PI*2,true);ctx.closePath();ctx.fill()};gDBox.Graph.drawPoints=function(ctx,ptArr){for(var i=0;i<ptArr.length;i++){var sxy={x:ptArr[i].x,y:ptArr[i].y};this.drawPoint(ctx,sxy)}};gDBox.Graph.drawPoints_geo=function(gMap,ctx,ptArr){for(var i=0;i<ptArr.length;i++){var sxy=gDBox.Util.worldToScreen(gMap,ptArr[i].x,ptArr[i].y);this.drawPoint(ctx,sxy)}};gDBox.Geometry=gClass.extend({init:function(name){this.name=name},getVertices:function(){},getBounds:function(){},calcBounds:function(){}});gDBox.Geometry.Point=gClass.extend({init:function(x,y){this.x=x;this.y=y;this.className="point"}});gDBox.Geometry.LineString=gDBox.Geometry.extend({init:function(points){this.className="line";this.points=[];for(var i=0;i<points.length;i++){var pt=points[i];if(pt instanceof gDBox.Geometry.Point){this.points.push(pt)}else{alert("初始化节点失败！")}}},addPoint:function(pt,index){var r=/^\d+$/;if(r.test(index)){this.points.splice(index,0,pt)}else{this.points.push(pt)}},delPoint:function(index){this.points.splice(index,1)},removePoint:function(pt){for(var i=0;i<this.points.length;i++){if(this.points[i]==pt){this.points.splice(i,1);break}}},getLength:function(){var len=this.points.length;var totalDis=0;for(var j=0;j<(len-1);j++){var mdis=Math.sqrt((this.points[j].x-this.points[j+1].x)*(this.points[j].x-this.points[j+1].x)+(this.points[j].y-this.points[j+1].y)*(this.points[j].y-this.points[j+1].y));totalDis=totalDis+mdis}return totalDis}});gDBox.Geometry.LinearRing=gDBox.Geometry.LineString.extend({init:function(points){var points_len=points.length;if(points_len<=2){alert("组成多边形节点个数不足！");return}this._super(points);this.className="polygon";var lastPoint=points[0];this.points.push(lastPoint)},addPoint:function(pt,index){this.points.splice(index,0,pt)},delPoint:function(index){if(this.points.length==4){alert("节点数低于3个，不能删除！");return}this.points.splice(index,1);if(index==0){this.points.pop();var firstPoint=this.points[0];this.points.push(firstPoint)}else{}},getCenterPoint:function(){var tmppoints=this.points;var points_len=tmppoints.length;var totalX=0;var totalY=0;for(var i=0;i<points_len;i++){totalX=totalX+tmppoints[i].x;totalY=totalY+tmppoints[i].y}var x=totalX/points_len;var y=totalY/points_len;var point=new gDBox.Geometry.Point(x,y);return point},getArea:function(){var ta=0;var ax=this.points;for(var i=0;i<ax.length;i++){ta=ta+(ax[i].x*ax[(i+1)%ax.length].y-ax[(i+1)%ax.length].x*ax[i].y)}var meter2=parseInt(Math.abs(0.5*ta));return meter2}});gDBox.Geometry.RectRing=gDBox.Geometry.LineString.extend({init:function(points){var points_len=points.length;if(points_len<4){alert("组成矩形节点个数不足！");return}this._super(points);this.className="rect"},addPoint:function(pt,index){this.points.splice(index,0,pt)},delPoint:function(index){if(this.points.length==4){alert("节点数低于3个，不能删除！");return}this.points.splice(index,1);if(index==0){this.points.pop();var firstPoint=this.points[0];this.points.push(firstPoint)}else{}},getArea:function(){var ta=0;var ax=this.points;for(var i=0;i<ax.length;i++){ta=ta+(ax[i].x*ax[(i+1)%ax.length].y-ax[(i+1)%ax.length].x*ax[i].y)}var meter2=parseInt(Math.abs(0.5*ta));return meter2}});gDBox.Geometry.RadiusRing=gDBox.Geometry.extend({init:function(point,radius){this.radius=radius;this.centerPoint=point;this.className="radius"},getArea:function(){return 2*3.14159*(this.radius)*(this.radius)}});gDBox.Feature=gClass.extend({init:function(){},getVertices:function(){return this.points},getBounds:function(){var points=this.getVertices();var minX=points[0].x,minY=points[0].y,maxX=points[0].x,maxY=points[0].y;for(var i=1;i<points.length;i++){if(minX>points[i].x){minX=points[i].x}if(maxX<points[i].x){maxX=points[i].x}if(minY>points[i].y){minY=points[i].y}if(maxY<points[i].y){maxY=points[i].y}}return[{x:minX,y:maxY},{x:maxX,y:maxY},{x:maxX,y:minY},{x:minX,y:minY}]},calcBounds:function(){}});gDBox.Feature.Polygon=gDBox.Feature.extend({init:function(points,data,gStyle){this.points=points;
    this.data=data||{};this.style=gStyle||new gDBox.Style({})},onAdd:function(layer){this._layerID=layer.id;this._layer=layer;this.onDraw(layer)},onRemove:function(layer){},update:function(options){this.points=options.points||this.points;this.data=options.data||this.data;this.style=options.style||this.style;this._layer.renew()},onDraw:function(layer){var ctx=layer.getCtx();var opt=gDBox.Util.setStyle(ctx,this.style);if(this.select){ctx.strokeStyle="#FF0000";ctx.lineWidth=2}var map=layer.getMap();ctx.globalAlpha=1;var len=this.points.length;if(len>=2){ctx.beginPath();var sxy=gDBox.Util.worldToScreen(layer._map,this.points[0].x,this.points[0].y);ctx.moveTo(sxy.x,sxy.y);for(var i=1;i<len;i++){sxy=gDBox.Util.worldToScreen(layer._map,this.points[i].x,this.points[i].y);ctx.lineTo(sxy.x,sxy.y)}ctx.closePath()}ctx.stroke();if(layer._opacity){ctx.globalAlpha=0}else{ctx.globalAlpha=this.style.opacity}ctx.fill();if(this.select){ctx.globalAlpha=1;ctx.fillStyle="#FF0000";gDBox.Graph.drawPoints_geo(map,ctx,this.points)}}});gDBox.Marker=gClass.extend({init:function(name,info){this.name=name;this._img=new Image();this._img.src=info.src;this.src=info.src;this._img.style.position="absolute";this._img.style.zIndex=100;this.info=info},onAdd:function(layer){this._layer=layer;var map=layer.getMap();var container=this._container=layer.getLayerContainer();this.x=this.info.x;this.y=this.info.y;var sxy=gDBox.Util.worldToScreen(map,this.info.x,this.info.y);this._img.style.left=sxy.x+this.info.offset.x+"px";this._img.style.top=sxy.y+this.info.offset.y+"px";this._img.style.cursor="pointer";container.appendChild(this._img)},onRemove:function(){this._container.removeChild(this._img)},regEvent:function(evt,callback){if(evt=="click"){var self=this;gDBox.Util.addEvtHandler(this._img,"mousedown",function(e){gDBox.Util.preventDefault(e);gDBox.Util.stopPropagation(e)});gDBox.Util.addEvtHandler(this._img,"mouseup",function(e){if(gDBox.Util.getButton(e)==0){callback.apply(self,arguments)}gDBox.Util.preventDefault(e);gDBox.Util.stopPropagation(e)});gDBox.Util.addEvtHandler(this._img,"click",function(e){gDBox.Util.preventDefault(e);gDBox.Util.stopPropagation(e)})}else{if(evt=="Rclick"){}}},renew:function(){var map=this._layer.getMap();var sxy=gDBox.Util.worldToScreen(map,this.info.x,this.info.y);this._img.style.left=sxy.x+this.info.offset.x+"px";this._img.style.top=sxy.y+this.info.offset.y+"px"},showInfo:function(){console.log("Hello ...")}});gDBox.Text=gClass.extend({init:function(id,info,gStyle){this.id=id;this.startPoint=info.pos;this.offset=info.offset||{x:0,y:0};this.boxMaxWidth=info.width;this.wrap=info.wrap||false;this.text=info.text;this.style=gStyle||new gDBox.Style({})},onAdd:function(layer){var id=this.id;this._w=this.boxMaxWidth;var div=gDBox.Util.createDiv(id,this._w,this._h,true);div.style.borderWidth=0;div.style.width="initial";div.style.maxWidth=this._w+"px";if(!this.wrap){div.style.overflow="hidden";div.style.textOverflow="ellipsis";div.style.whiteSpace="nowrap"}this._textContainer=div;var container=this._container=layer.getLayerContainer();container.appendChild(this._textContainer);this._layer=layer;this.onDraw(layer)},onDraw:function(layer){var left_top=gDBox.Util.worldToScreen(layer._map,this.startPoint.x,this.startPoint.y);left_top.x=left_top.x+this.offset.x;left_top.y=left_top.y+this.offset.y;this._textContainer.style.fontSize=this.style.fontSize+"px";this._textContainer.style.lineHeight=this.style.fontSize+"px";this._textContainer.style.fontFamily=this.style.fontFamily+",SimSun";this._textContainer.style.color=this.style.fontColor;this._textContainer.style.borderRadius="1px";this._textContainer.style.boxSizing="border-box";this._textContainer.style.padding="1px";var rgba=gDBox.Util.colorRgb(this.style.bgColor,this.style.opacity||1);this._textContainer.style.background=rgba;this._textContainer.textContent=this.text;this._textContainer.style.left=left_top.x+"px";this._textContainer.style.top=left_top.y+"px";layer._layerContainer.appendChild(this._textContainer)},setText:function(newText){this.text=newText;this.refresh()},setPosition:function(wx,wy){this.startPoint.x=wx;this.startPoint.y=wy},setSize:function(width){this._w=this.boxMaxWidth=width},onRemove:function(){this._container.removeChild(this._textContainer)},getContainer:function(){return this._textContainer},renew:function(){var layer=this._layer;this.onDraw(layer)},refresh:function(){this.renew()}});gDBox.Style=gClass.extend({init:function(options){this.oStyle="singleStyle";if(options.fillColor==undefined){this.fillColor="#00DD00"}else{this.fillColor=options.fillColor}if(options.strokeColor==undefined){this.strokeColor="#00DD00"}else{this.strokeColor=options.strokeColor}if(options.lineWeight==undefined){this.lineWeight=1}else{this.lineWeight=options.lineWeight}if(options.borderStatus==undefined){this.borderStatus=true}else{this.borderStatus=false}if(options.cirRadius==undefined){this.cirRadius=3}else{this.cirRadius=options.cirRadius}if(options.fillStatus==undefined){this.fillStatus=true
    }else{this.fillStatus=false}if(options.vtxStatus==undefined){this.vtxStatus=false}else{this.vtxStatus=true}if(options.vtxRadius==undefined){this.vtxRadius=3}else{this.vtxRadius=options.vtxRadius}if(options.tlr==undefined){this.tlr=5}else{this.tlr=options.tlr}if(options.opacity==undefined){this.opacity=1}else{this.opacity=options.opacity}if(options.mappingValue==undefined){this.mappingValue="default"}else{this.mappingValue=options.mappingValue}if(options.fontSize==undefined){this.fontSize=13}else{this.fontSize=options.fontSize}if(options.fontFamily==undefined){this.fontFamily="KaiTi"}else{this.fontFamily=options.fontFamily}if(options.fontColor==undefined){this.fontColor="#333333"}else{this.fontColor=options.fontColor}if(options.bgColor==undefined){this.bgColor="#ffffff"}else{this.bgColor=options.bgColor}}});gDBox.Style_Ex=gClass.extend({init:function(styleArr,field){this.oStyle="multiStyles";this.styles=styleArr;this.mappingField=field}});gDBox.Map=gClass.extend({init:function(containerId,options){this._options=options||{};this._initContainer(containerId);this._initProp();this._initEvent();this.overLayer=new gDBox.Layer.Overlay("overlay");this.mLayer=new gDBox.Layer.Marker("markerLayer");this.addLayer(this.overLayer);this.addLayer(this.mLayer)},_initContainer:function(containerId){this._container=document.getElementById(containerId);this._container.innerHTML="";this.w=this._options.w||this._container.clientWidth;this.h=this._options.h||this._container.clientHeight;this._container.style.overflow="hidden"},getContainer:function(){return this._container},getSize:function(){return{w:this.w,h:this.h}},events:{on:function(eventType,callback){switch(eventType){case"mouseDown":gDBox.Map.prototype._mouseDown_EX=function(pos){callback(pos)};break;case"geometryDone":gDBox.Map.prototype._geometryDone_EX=function(type,result){callback(type,result)};break;case"selected":gDBox.Map.prototype._fetureSelected_EX=function(result){callback(result)};break}}},_mouseDown_EX:function(){},_geometryDone_EX:function(){},_fetureSelected_EX:function(){},_initProp:function(){this.mode="pan";this.selectMode="up";this.dragging=false;this.oLayers=[];this.zoom=this._options.zoom||parseInt(1*this.w);this.cx=this._options.cx||0;this.cy=this._options.cy||0;this.startX=0;this.startY=0;this.startScrX=0;this.startSrcY=0;this.zoomScale=1/40;this.zoomMax=this._options.zoomMax||1000000000;this.zoomMin=this._options.zoomMin||0;this.draw_rect_points=[]},_initEvent:function(){var gSelf=this;var doc=document.documentElement;var ctn=this._container;gDBox.Util.addEvtHandler(ctn,"mousedown",mapMouseDownStart);gDBox.Util.addEvtHandler(ctn,"mousemove",mapMouseMoveEvt);gDBox.Util.addEvtHandler(ctn,"mouseup",mapMouseUpEvt);gDBox.Util.addEvtHandler(ctn,"mousewheel",mapMouseWheelEvt);function mapMouseDownStart(e){var e=e?e:window.event;if(!window.event){e.preventDefault()}var mxy=gDBox.Util.getMouseXY(gSelf._container,e);var wxy=gDBox.Util.screenToWorld(gSelf,mxy.x,mxy.y);var scrxy=gDBox.Util.getMousePos(e);gSelf.startX=mxy.x;gSelf.startY=mxy.y;gSelf.startScrX=scrxy.x;gSelf.startScrY=scrxy.y;gSelf._mouseDown_EX&&gSelf._mouseDown_EX(wxy);if(gSelf.mode=="pan"){mapMouseDown_pan(e);document.onmousemove=function(e){mapMouseMove_pan(e)};document.onmouseup=function(e){document.onmousemove=null;document.onmouseup=null;mapMouseUp_pan(e)}}else{mapMouseDownEvt(e)}}function mapMouseDown_pan(e){gSelf.dragging=true;var oLayers=gSelf.getAllLayers();for(var i=0;i<oLayers.length;i++){oLayers[i].startLeft=gDBox.Util.delpx(oLayers[i]._layerContainer.style.left);oLayers[i].startTop=gDBox.Util.delpx(oLayers[i]._layerContainer.style.top)}}function mapMouseMove_pan(e){var mxy=gDBox.Util.getMouseXY(gSelf._container,e);var scrxy=gDBox.Util.getMousePos(e);if(gSelf.dragging){var dltx=scrxy.x-gSelf.startScrX;var dlty=scrxy.y-gSelf.startScrY;var oLayers=gSelf.getAllLayers();if(Math.abs(dltx)>0||Math.abs(dlty)>0){for(var i=0;i<oLayers.length;i++){oLayers[i].onDrag(dltx,dlty)}}}}function mapMouseUp_pan(e){var mxy=gDBox.Util.getMouseXY(gSelf._container,e);var scrxy=gDBox.Util.getMousePos(e);var dltx=scrxy.x-gSelf.startScrX;var dlty=scrxy.y-gSelf.startScrY;if(Math.abs(dltx)>0||Math.abs(dlty)>0){var scxy=gSelf.getScreenCenter();var nscx=scxy.x-dltx;var nscy=scxy.y-dlty;var wxy=gDBox.Util.screenToWorld(gSelf,nscx,nscy);gSelf.setCenter(wxy.x,wxy.y);var oLayers=gSelf.getAllLayers();var lyrs_len=oLayers.length;for(var i=0;i<lyrs_len;i++){oLayers[i].renew()}}gSelf.dragging=false}function mapMouseDownEvt(e){var mxy=gDBox.Util.getMouseXY(gSelf._container,e);var wxy=gDBox.Util.screenToWorld(gSelf,mxy.x,mxy.y);switch(gSelf.mode){case"drawRect":var startPoint=new gDBox.Geometry.Point(wxy.x,wxy.y);gSelf.draw_rect_points.push(startPoint);break;case"select":if(gSelf.selectMode==="up"){return}selectEvent(wxy);break}}function selectEvent(wxy){var oLayers=gSelf.getAllLayers();var result=[];for(var i=0;i<oLayers.length;i++){result=result.concat(oLayers[i].getSelectTarget({x:wxy.x,y:wxy.y}))}gSelf._fetureSelected_EX&&gSelf._fetureSelected_EX(result);
    return result}function mapMouseMoveEvt(e){var mxy=gDBox.Util.getMouseXY(gSelf._container,e);var wxy=gDBox.Util.screenToWorld(gSelf,mxy.x,mxy.y);switch(gSelf.mode){case"drawRect":if(gSelf.draw_rect_points.length>0){gSelf.overLayer.clear();var ctx=gSelf.overLayer.getCtx();gDBox.Util.setStyle(ctx,gSelf.globalStyle);var w=mxy.x-gSelf.startX;var h=mxy.y-gSelf.startY;ctx.strokeRect(gSelf.startX,gSelf.startY,w,h)}break}}function mapMouseUpEvt(e){var mxy=gDBox.Util.getMouseXY(gSelf._container,e);var wxy=gDBox.Util.screenToWorld(gSelf,mxy.x,mxy.y);switch(gSelf.mode){case"drawRect":var startPoint=gSelf.draw_rect_points[0];gSelf.draw_rect_points=[];var endPoint=new gDBox.Geometry.Point(wxy.x,wxy.y);var rectPoints=gDBox.Util.getRectPointsWithSAndE(startPoint,endPoint);gSelf.overLayer.clear();if(Math.abs(rectPoints[0].x-rectPoints[2].x)>10&&Math.abs(rectPoints[0].y-rectPoints[2].y)>10){gSelf._geometryDone_EX&&gSelf._geometryDone_EX("rect",rectPoints)}else{if(gSelf.selectMode==="down"){return}var selectResult=selectEvent(wxy);if(!selectResult.length){console.log("invalid points data: 不是有效矩形框...")}}break}}function mapMouseWheelEvt(e){gDBox.Util.preventDefault(e);var mxy=gDBox.Util.getMouseXY(gSelf._container,e);var wxy=gDBox.Util.screenToWorld(gSelf,mxy.x,mxy.y);if(gSelf.mode==="pan"){var delta=e.wheelDelta||-e.detail;if(delta>0){if(gSelf.zoom<=this.zoomMin){return}var halfwdltx=(wxy.x-gSelf.cx)*(1-gSelf.zoomScale);var halfwdlty=(wxy.y-gSelf.cy)*(1-gSelf.zoomScale);var newcx=wxy.x-halfwdltx;var newcy=wxy.y-halfwdlty;gSelf.setCenter(newcx,newcy);gSelf.zoomIn(1)}else{if(gSelf.zoom>=this.zoomMax){return}var halfwdltx=(wxy.x-gSelf.cx)/(1-gSelf.zoomScale);var halfwdlty=(wxy.y-gSelf.cy)/(1-gSelf.zoomScale);var newcx=wxy.x-halfwdltx;var newcy=wxy.y-halfwdlty;gSelf.setCenter(newcx,newcy);gSelf.zoomOut(1)}}}},addLayer:function(layer){var oLayers=this.oLayers;if(!gDBox.Util.isObjInArray(oLayers,layer)){layer.onAdd(this);oLayers.push(layer)}},removeLayer:function(layer){},setActiveLayer:function(layer){var oLayers=this.getAllLayers();for(var i=0;i<oLayers.length;i++){if(oLayers[i]==layer){oLayers[i].active()}else{oLayers[i].deActive()}}},getAllLayers:function(){return this.oLayers},getNewZoom:function(type,num){var i=num?num:6;var newZoom=this.zoom;while(i>0){if(type==="zoomIn"){newZoom=newZoom-(newZoom*this.zoomScale)}else{newZoom=newZoom/(1-this.zoomScale)}i--}return newZoom},zoomIn:function(num){if(this.zoom<=this.zoomMin){return}var oLayers=this.getAllLayers();var newZoom=this.getNewZoom("zoomIn",num);this.zoom=newZoom;for(var i=0;i<oLayers.length;i++){oLayers[i].zoomIn()}},zoomOut:function(num){if(this.zoom>=this.zoomMax){return}var oLayers=this.getAllLayers();var newZoom=this.getNewZoom("zoomOut",num);this.zoom=newZoom;for(var i=0;i<oLayers.length;i++){oLayers[i].zoomOut()}},setMode:function(mode,style){this.mode=mode;this.globalStyle=style||new gDBox.Style({})},getMode:function(){return this.mode},deSelect:function(){var oLayers=this.getAllLayers();for(var i=0;i<oLayers.length;i++){oLayers[i].deSelect()}this.overLayer.clear();this.draw_rect_points=[]},setCenter:function(cx,cy){this.cx=cx;this.cy=cy},getCenter:function(){return{x:this.cx,y:this.cy}},getScreenCenter:function(){return{x:this.w/2,y:this.h/2}},setCenter:function(cx,cy){this.cx=cx;this.cy=cy},destroy:function(){this._container.innerHTML="";var ctn=this._container;gDBox.Util.removeEvtHandler(ctn,"mousedown");gDBox.Util.removeEvtHandler(ctn,"mousemove");gDBox.Util.removeEvtHandler(ctn,"mouseup");gDBox.Util.removeEvtHandler(ctn,"mousewheel")}});gDBox.Layer=gClass.extend({init:function(id,options){this.id=id;this.visible=true;this.options={opacity:1,zIndex:0}},onAdd:function(map){var self=this;this._map=map;this._container=map.getContainer();var size=map.getSize();this._initLayerContainer(this.id,size.w,size.h);this._initProp(map);this._initParams(map);this._container.appendChild(this._layerContainer);this.setzIndex();this.setOpacity(this.options.opacity)},onRemove:function(map){},_initProp:function(map){this.deActive()},_initParams:function(map){},onDrag:function(dltx,dlty){this._layerContainer.style.left=this.startLeft+dltx+"px";this._layerContainer.style.top=this.startTop+dlty+"px"},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},renew:function(){this._layerContainer.style.left=0+"px";this._layerContainer.style.top=0+"px"},getSize:function(){return{w:this._layerContainer.clientWidth,h:this._layerContainer.clientHeight}},getScreenCenter:function(){return{x:parseInt(this._layerContainer.clientWidth/2),y:parseInt(this._layerContainer.clientHeight/2)}},getMap:function(){return this._map},getLayerContainer:function(){return this._layerContainer},setzIndex:function(){if(!isNaN(this.options.zIndex)){this._layerContainer.style.zIndex=this.options.zIndex}},setOpacity:function(val){this.getLayerContainer().style.opacity=val},resize:function(){this._layerContainer.style.width=this._map.w+"px";this._layerContainer.style.height=this._map.h+"px"
    },active:function(){if(this.oClass!=="featureLayer"){return}this.activeStatus=true},deActive:function(){this.activeStatus=false},getSelectTarget:function(){return[]},deSelect:function(){}});gDBox.Layer.Image=gDBox.Layer.extend({init:function(id,src,size,options){this._super(id,options);this._src=src;this._size=size;this.oClass="imgLayer"},_initParams:function(map){},_initProp:function(map){this._super();if(!this._mapImg){this._mapImg=new Image()}this._mapImg.style.position="absolute";this._mapImg.src=this._src;this._mapImg.onmousedown=function(e){e.preventDefault()};this._layerContainer.appendChild(this._mapImg);this.renew()},_initLayerContainer:function(id,w,h){var div=gDBox.Util.createDiv(id,w,h,true);div.style.zIndex=2;this._layerContainer=div},onAdd:function(map){this._super(map)},zoomTo:function(){},renew:function(){this._super();var size=this._map.getSize();var scale=this._map.zoom/size.w;this._mapImg.width=this._size.w/scale;var sxyLeftTop=gDBox.Util.worldToScreen(this._map,-1*this._size.w/2,this._size.h/2);this._mapImg.style.left=sxyLeftTop.x+"px";this._mapImg.style.top=sxyLeftTop.y+"px"},resize:function(){},refresh:function(){}});gDBox.Layer.Feature=gDBox.Layer.extend({init:function(id,options){this._super(id,options);var defaultStyle=new gDBox.Style({});this.style=defaultStyle;this._opacity=(options&&options.transparent)?options.transparent:false;this.oClass="featureLayer"},_initLayerContainer:function(id,w,h){var canvas=gDBox.Util.createCanvas(id,w,h,true);this._layerContainer=canvas;this._ctx=canvas.getContext("2d");this._layerContainer.style.left="0px";this._layerContainer.style.top="0px"},_initProp:function(map){this._super()},onAdd:function(map){this._map=map;var size=map.getSize();var container=this._map.getContainer();this._initLayerContainer(this.id,size.w,size.h);container.appendChild(this._layerContainer);this.setzIndex();this.oFeatures=[]},addFeature:function(feature){var oFeatures=this.getAllFeatures();if(!gDBox.Util.isInArray(oFeatures,feature)){oFeatures.push(feature);feature.onAdd(this)}},getSelectTarget:function(point){var result=[];if(!this.activeStatus){return result}var isFeatureSelected=false;var oFeatures=this.getAllFeatures();for(var i=(oFeatures.length-1);i>=0;i--){oFeatures[i].select=false;if(gDBox.Util.pointInPoly(point,oFeatures[i].points)&&!isFeatureSelected){isFeatureSelected=true;oFeatures[i].select=true;result.push(oFeatures[i])}}this.renew();return result.length?[result[0]]:result},deSelect:function(){var oFeatures=this.getAllFeatures();for(var i=0;i<oFeatures.length;i++){oFeatures[i].select=false}this.renew()},removeAllFeatures:function(){this.oFeatures=[];this.renew()},removeFeature:function(feature){var oFeature=[];for(var i=0,a=0;i<this.oFeatures.length;i++){if(this.oFeatures[i]!=feature){oFeature[a]=this.oFeatures[i];a++}else{feature.onRemove(this)}}this.oFeatures=oFeature;var map=this.getMap();this.renew()},draw:function(){var oFeatures=this.getAllFeatures();for(var i=0;i<oFeatures.length;i++){oFeatures[i].onDraw(this)}},renew:function(){this._super();this.clear();this.draw()},resize:function(){this._super();this._layerContainer.width=this._map.w;this._layerContainer.height=this._map.h;this.renew()},clear:function(){var canvas=this.getLayerContainer();this._ctx.clearRect(0,0,canvas.width,canvas.height)},getAllFeatures:function(){return this.oFeatures},getCtx:function(){return this._ctx}});gDBox.Layer.Overlay=gDBox.Layer.Feature.extend({init:function(id,options){this._super(id,options);this.options=options||{opacity:1,zIndex:10};this.oClass="overlayLayer"},setStyle:function(style){this.style=style},initStyle:function(){var ctx=this.getCtx();ctx.strokeStyle="green";ctx.fillStyle="green";this._layerContainer.style.left="0px";this._layerContainer.style.top="0px";ctx.gloablAlpha=0.7},onAdd:function(map){this._super(map);this.initStyle()},resize:function(){this._super();this._layerContainer.width=this._map.w;this._layerContainer.height=this._map.h;this.renew()}});gDBox.Layer.Marker=gDBox.Layer.extend({init:function(id,options){this._super(id,options);this.options=options||{opacity:1,zIndex:20};this.id=id;this.oClass="markerLayer";this.oMarkers=[]},_initLayerContainer:function(id,w,h){var div=gDBox.Util.createDiv(id,w,h,true);this._layerContainer=div},addMarker:function(marker){if(!gDBox.Util.isInArray(this.oMarkers,marker)){this.oMarkers.push(marker);marker.onAdd(this)}},removeMarker:function(marker){var oMarker=[];for(var i=0,a=0;i<this.oMarkers.length;i++){if(this.oMarkers[i]!=marker){oMarker[a]=this.oMarkers[i];a++}else{this.oMarkers[i].onRemove(this)}}this.oMarkers=oMarker;this.renew()},getAllMarkers:function(){return this.oMarkers},addMarkers:function(markers){var oMarkers=this.oMarkers;for(var i=0;i<markers.length;i++){this.addMarker(markers[i])}},removeMarkers:function(markers){var removeMarkers=markers;var len_removeMarkers=removeMarkers.length;for(var i=0;i<len_removeMarkers;i++){var tmpremoveMark=removeMarkers[i];this.removeMarker(tmpremoveMark)}},removeAllMarkers:function(){var oMarkers=this.oMarkers;
    this.removeMarkers(oMarkers)},renew:function(){this._super();for(var i=0;i<this.oMarkers.length;i++){this.oMarkers[i].renew()}},resize:function(){this._super();this.renew()}});gDBox.Layer.Text=gDBox.Layer.extend({init:function(id,options){this._super(id,options);this.options=options||{opacity:1,zIndex:19};this.id=id;this.oClass="textLayer";this.oTexts=[]},_initLayerContainer:function(id,w,h){var div=gDBox.Util.createDiv(id,w,h,true);this._layerContainer=div},addText:function(textObj){if(!gDBox.Util.isInArray(this.oTexts,textObj)){this.oTexts.push(textObj);textObj.onAdd(this)}},removeText:function(textObj){var oText=[];for(var i=0,a=0;i<this.oTexts.length;i++){if(this.oTexts[i]!=textObj){oText[a]=this.oTexts[i];a++}else{this.oTexts[i].onRemove(this)}}this.oTexts=oText;this.renew()},getTextById:function(id){for(var i=0,a=0;i<this.oTexts.length;i++){if(this.oTexts[i].id===id){return this.oTexts[i]}}return null},removeTextById:function(id){var oText=[];for(var i=0,a=0;i<this.oTexts.length;i++){if(this.oTexts[i].id!=id){oText[a]=this.oTexts[i];a++}else{this.oTexts[i].onRemove(this)}}this.oTexts=oText;this.renew()},addTexts:function(textObjs){var oTexts=this.oTexts;for(var i=0;i<textObjs.length;i++){this.addText(textObjs[i])}},removeTexts:function(textObjs){var removeTexts=textObjs;var len_removeTexts=removeTexts.length;for(var i=0;i<len_removeTexts;i++){var tmpremoveText=removeTexts[i];this.removeText(tmpremoveText)}},getAllTexts:function(){return this.oTexts},removeAllTexts:function(){this._layerContainer.innerHTML="";this.oTexts=[];this.renew()},renew:function(){this._super();for(var i=0;i<this.oTexts.length;i++){this.oTexts[i].renew()}},resize:function(){this._super();this.renew()}});
    //兼容CommonJs规范   
    if (typeof module !== 'undefined' && module.exports) {
        module.exports = gDBox;
    };
    //兼容AMD/CMD规范  
    if (typeof define === 'function') define(function() {   
        return gDBox;   
    });
    //注册全局变量，兼容直接使用script标签引入插件
    global.gDBox= gDBox;
})(window); 